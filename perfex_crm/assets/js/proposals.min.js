function init_proposal_editor(){tinymce.remove("div.editable");var e=[];$.each(proposal_templates,function(t,o){e.push({url:admin_url+"proposals/get_template?name="+o,title:o})});var t={selector:"div.editable",inline:!0,theme:"modern",skin:"perfex",relative_urls:!1,remove_script_host:!1,inline_styles:!0,verify_html:!1,cleanup:!1,valid_elements:"+*[*]",valid_children:"+body[style], +style[type]",apply_source_formatting:!1,file_browser_callback:elFinderBrowser,table_class_list:[{title:"Flat",value:"table"},{title:"Table Bordered",value:"table table-bordered"},{title:"Items Table",value:"proposal-items table"}],table_default_styles:{width:"100%"},removed_menuitems:"newdocument",fontsize_formats:"8pt 10pt 12pt 14pt 18pt 24pt 36pt",plugins:["advlist pagebreak autolink autoresize lists link image charmap hr anchor","searchreplace wordcount visualblocks visualchars code","media nonbreaking save table contextmenu directionality","paste textcolor colorpicker"],autoresize_bottom_margin:50,pagebreak_separator:'<p pagebreak="true"></p>',toolbar1:"save_button fontselect fontsizeselect insertfile | styleselect",toolbar2:"bold italic | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent",toolbar3:"media image | forecolor backcolor link ",setup:function(e){e.on("blur",function(){$.Shortcuts.start()}),e.on("focus",function(){$.Shortcuts.stop()}),e.addButton("save_button",{text:appLang.proposal_save,icon:!1,id:"inline-editor-save-btn",onclick:function(){var t={};t.proposal_id=proposal_id,t.content=e.getContent(),$.post(admin_url+"proposals/save_proposal_data",t).done(function(e){1==(e=JSON.parse(e)).success&&alert_float("success",e.message)}).fail(function(e){var t=JSON.parse(e.responseText);alert_float("danger",t.message)})}})}};e.length>0&&(t.templates=e,t.plugins[3]="template "+t.plugins[3]),tinymce.init(t)}function add_proposal_comment(){var e=$("#comment").val();if(""!=e){var t={};t.content=e,t.proposalid=proposal_id,$("body").append('<div class="dt-loader"></div>'),$.post(admin_url+"proposals/add_proposal_comment",t).done(function(e){e=JSON.parse(e),$("body").find(".dt-loader").remove(),1==e.success&&($("#comment").val(""),get_proposal_comments())})}}function get_proposal_comments(){"undefined"!=typeof proposal_id&&requestGet("proposals/get_proposal_comments/"+proposal_id).done(function(e){$("body").find("#proposal-comments").html(e)})}function remove_proposal_comment(e){confirm_delete()&&requestGetJSON("proposals/remove_comment/"+e).done(function(t){1==t.success&&$('[data-commentid="'+e+'"]').remove()})}function edit_proposal_comment(e){var t=$("body").find('[data-proposal-comment-edit-textarea="'+e+'"] textarea').val();""!=t&&($.post(admin_url+"proposals/edit_comment/"+e,{content:t}).done(function(o){1==(o=JSON.parse(o)).success&&(alert_float("success",o.message),$("body").find('[data-proposal-comment="'+e+'"]').html(nl2br(t)))}),toggle_proposal_comment_edit(e))}function toggle_proposal_comment_edit(e){$("body").find('[data-proposal-comment="'+e+'"]').toggleClass("hide"),$("body").find('[data-proposal-comment-edit-textarea="'+e+'"]').toggleClass("hide")}function convert_template(e){var t,o=$(e).data("template");if("estimate"==o)t="estimate";else{if("invoice"!=o)return!1;t="invoice"}requestGet("proposals/get_"+t+"_convert_data/"+proposal_id).done(function(e){$(".proposal-pipeline-modal").is(":visible")&&$(".proposal-pipeline-modal").modal("hide"),$("#convert_helper").html(e),$("#convert_to_"+t).modal({show:!0,backdrop:"static"}),reorder_items()})}$(function(){get_proposal_comments(),$("body").on("click",".dismiss-proposal-convert-modal",function(e){e.preventDefault(),$("body").find(".proposal-convert-modal").modal("hide")})});