//     jquery-comments.js 1.2.0

//     (c) 2017 Joona TykkylÃ¤inen, Viima Solutions Oy
//     jquery-comments may be freely distributed under the MIT license.
//     For all details and documentation:
//     http://viima.github.io/jquery-comments/

!function(a){"function"==typeof define&&define.amd?define(["jquery"],a):"object"==typeof module&&module.exports?module.exports=function(b,c){return void 0===c&&(c="undefined"!=typeof window?require("jquery"):require("jquery")(b)),a(c),c}:a(jQuery)}(function(a){var b={$el:null,commentsById:{},usersById:{},dataFetched:!1,currentSortKey:"",options:{},events:{click:"closeDropdowns","keydown [contenteditable]":"saveOnKeydown","focus [contenteditable]":"saveEditableContent","keyup [contenteditable]":"checkEditableContentForChange","paste [contenteditable]":"checkEditableContentForChange","input [contenteditable]":"checkEditableContentForChange","blur [contenteditable]":"checkEditableContentForChange","click .navigation li[data-sort-key]":"navigationElementClicked","click .navigation li.title":"toggleNavigationDropdown","click .commenting-field.main .textarea":"showMainCommentingField","click .commenting-field.main .close":"hideMainCommentingField","click .commenting-field .textarea":"increaseTextareaHeight","change .commenting-field .textarea":"increaseTextareaHeight textareaContentChanged","click .commenting-field:not(.main) .close":"removeCommentingField","click .commenting-field .send.enabled":"postComment","click .commenting-field .update.enabled":"putComment","click .commenting-field .delete.enabled":"deleteComment",'change .commenting-field .upload.enabled input[type="file"]':"fileInputChanged","click li.comment button.upvote":"upvoteComment","click li.comment button.delete.enabled":"deleteComment","click li.comment .hashtag":"hashtagClicked","click li.comment .ping":"pingClicked","click li.comment ul.child-comments .toggle-all":"toggleReplies","click li.comment button.reply":"replyButtonClicked","click li.comment button.edit":"editButtonClicked",dragenter:"showDroppableOverlay","dragenter .droppable-overlay":"handleDragEnter","dragleave .droppable-overlay":"handleDragLeaveForOverlay","dragenter .droppable-overlay .droppable":"handleDragEnter","dragleave .droppable-overlay .droppable":"handleDragLeaveForDroppable","dragover .droppable-overlay":"handleDragOverForOverlay","drop .droppable-overlay":"handleDrop","click .dropdown.autocomplete":"stopPropagation","mousedown .dropdown.autocomplete":"stopPropagation","touchstart .dropdown.autocomplete":"stopPropagation"},getDefaultOptions:function(){return{profilePictureURL:"",currentUserIsAdmin:!1,currentUserId:null,spinnerIconURL:"",upvoteIconURL:"",replyIconURL:"",uploadIconURL:"",attachmentIconURL:"",fileIconURL:"",noCommentsIconURL:"",textareaPlaceholderText:"Add a comment",newestText:"Newest",oldestText:"Oldest",popularText:"Popular",attachmentsText:"Attachments",sendText:"Send",replyText:"Reply",editText:"Edit",editedText:"Edited",youText:"You",saveText:"Save",deleteText:"Delete",viewAllRepliesText:"View all __replyCount__ replies",hideRepliesText:"Hide replies",noCommentsText:"No comments",noAttachmentsText:"No attachments",attachmentDropText:"Drop files here",textFormatter:function(a){return a},enableReplying:!0,enableEditing:!0,enableUpvoting:!0,enableDeleting:!0,enableAttachments:!1,enableHashtags:!1,enablePinging:!1,enableDeletingCommentWithReplies:!1,enableNavigation:!0,postCommentOnEnter:!1,forceResponsive:!1,readOnly:!1,defaultNavigationSortKey:"newest",highlightColor:"#2793e6",deleteButtonColor:"#C9302C",roundProfilePictures:!1,textareaRows:2,textareaRowsOnFocus:2,textareaMaxRows:5,maxRepliesVisible:2,fieldMappings:{id:"id",parent:"parent",created:"created",modified:"modified",content:"content",file:"file",fileURL:"file_url",fileMimeType:"file_mime_type",pings:"pings",creator:"creator",fullname:"fullname",profileURL:"profile_url",profilePictureURL:"profile_picture_url",createdByAdmin:"created_by_admin",createdByCurrentUser:"created_by_current_user",upvoteCount:"upvote_count",userHasUpvoted:"user_has_upvoted"},getUsers:function(a,b){a([])},getComments:function(a,b){a([])},postComment:function(a,b,c){b(a)},putComment:function(a,b,c){b(a)},deleteComment:function(a,b,c){b()},upvoteComment:function(a,b,c){b(a)},hashtagClicked:function(a){},pingClicked:function(a){},uploadAttachments:function(a,b,c){b(a)},refresh:function(){},timeFormatter:function(a){return new Date(a).toLocaleDateString()}}},init:function(b,c){this.$el=a(c),this.$el.addClass("jquery-comments"),this.undelegateEvents(),this.delegateEvents(),function(a){(jQuery.browser=jQuery.browser||{}).mobile=/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino/i.test(a)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(a.substr(0,4))}(navigator.userAgent||navigator.vendor||window.opera),a.browser.mobile&&this.$el.addClass("mobile"),this.options=a.extend(!0,{},this.getDefaultOptions(),b),this.options.readOnly&&this.$el.addClass("read-only"),this.currentSortKey=this.options.defaultNavigationSortKey,this.createCssDeclarations(),this.fetchDataAndRender()},delegateEvents:function(){this.bindEvents(!1)},undelegateEvents:function(){this.bindEvents(!0)},bindEvents:function(b){var c=b?"off":"on";for(var d in this.events){var e=d.split(" ")[0],f=d.split(" ").slice(1).join(" "),g=this.events[d].split(" ");for(var h in g)if(g.hasOwnProperty(h)){var i=this[g[h]];i=a.proxy(i,this),""==f?this.$el[c](e,i):this.$el[c](e,f,i)}}},fetchDataAndRender:function(){var b=this;this.commentsById={},this.usersById={},this.$el.empty(),this.createHTML();var c=this.after(this.options.enablePinging?2:1,function(){b.dataFetched=!0,b.render()}),d=function(d){var e=d.map(function(a){return b.createCommentModel(a)});b.sortComments(e,"oldest"),a(e).each(function(a,c){b.addCommentToDataModel(c)}),c()};if(this.options.getComments(d,c),this.options.enablePinging){var e=function(d){a(d).each(function(a,c){b.usersById[c.id]=c}),c()};this.options.getUsers(e,c)}},fetchNext:function(){var b=this,c=this.createSpinner();this.$el.find("ul#comment-list").append(c);var d=function(d){a(d).each(function(a,c){b.createComment(c)}),c.remove()},e=function(){c.remove()};this.options.getComments(d,e)},createCommentModel:function(a){var b=this.applyInternalMappings(a);return b.childs=[],b},addCommentToDataModel:function(a){if(!(a.id in this.commentsById)&&(this.commentsById[a.id]=a,a.parent)){var b=this.getOutermostParent(a.parent);b.childs.push(a.id)}},updateCommentModel:function(b){a.extend(this.commentsById[b.id],b)},render:function(){this.dataFetched&&(this.showActiveContainer(),this.createComments(),this.options.enableAttachments&&this.createAttachments(),this.$el.find("> .spinner").remove(),this.options.refresh())},showActiveContainer:function(){var a=this.$el.find(".navigation li[data-container-name].active"),b=a.data("container-name"),c=this.$el.find('[data-container="'+b+'"]');c.siblings("[data-container]").hide(),c.show()},createComments:function(){var b=this;this.$el.find("#comment-list").remove();var c=a("<ul/>",{id:"comment-list",class:"main"}),d=[],e=[];a(this.getComments()).each(function(a,b){null==b.parent?d.push(b):e.push(b)}),this.sortComments(d,this.currentSortKey),d.reverse(),a(d).each(function(a,d){b.addComment(d,c)}),this.sortComments(e,"oldest"),a(e).each(function(a,d){b.addComment(d,c)}),this.$el.find('[data-container="comments"]').prepend(c)},createAttachments:function(){var b=this;this.$el.find("#attachment-list").remove();var c=a("<ul/>",{id:"attachment-list",class:"main"}),d=this.getAttachments();this.sortComments(d,"newest"),d.reverse(),a(d).each(function(a,d){b.addAttachment(d,c)}),this.$el.find('[data-container="attachments"]').prepend(c)},addComment:function(a,b){b=b||this.$el.find("#comment-list");var c=this.createCommentElement(a);if(a.parent){var d=b.find('.comment[data-id="'+a.parent+'"]');this.reRenderCommentActionBar(a.parent);var e=d.parents(".comment").last();0==e.length&&(e=d);var f=e.find(".child-comments"),g=f.find(".commenting-field");g.length?g.before(c):f.append(c),this.updateToggleAllButton(e)}else b.prepend(c)},addAttachment:function(a,b){b=b||this.$el.find("#attachment-list");var c=this.createCommentElement(a);b.prepend(c)},removeComment:function(b){var c=this,d=this.commentsById[b],e=this.getChildComments(d.id);if(a(e).each(function(a,b){c.removeComment(b.id)}),d.parent){var f=this.getOutermostParent(d.parent),g=f.childs.indexOf(d.id);f.childs.splice(g,1)}delete this.commentsById[b];var h=this.$el.find('li.comment[data-id="'+b+'"]'),i=h.parents("li.comment").last();h.remove(),this.updateToggleAllButton(i)},uploadAttachments:function(b,c){var d=this;c||(c=this.$el.find(".commenting-field.main"));var e=!c.hasClass("main"),f=b.length;if(f){var g=c.find(".upload"),h=c.find(".textarea");g.removeClass("enabled");var i=this.createSpinner(),j=this.createSpinner();this.$el.find("ul#attachment-list").prepend(i),e?c.before(j):this.$el.find("ul#comment-list").prepend(j);var k=function(b){a(b).each(function(a,b){var c=d.createCommentModel(b);d.addCommentToDataModel(c),d.addComment(c),d.addAttachment(c)}),b.length==f&&0==d.getTextareaContent(h).length&&c.find(".close").trigger("click"),g.addClass("enabled"),j.remove(),i.remove()},l=function(){g.addClass("enabled"),j.remove(),i.remove()},m=[];a(b).each(function(a,b){var c=d.createCommentJSON(h);c.id+="-"+a,c.content="",c.file=b,c.fileURL="C:/fakepath/"+b.name,c.fileMimeType=b.type,c=d.applyExternalMappings(c),m.push(c)}),d.options.uploadAttachments(m,k,l)}g.find("input").val("")},updateToggleAllButton:function(b){var c=b.find(".child-comments"),d=c.find(".comment"),e=c.find("li.toggle-all");d.removeClass("hidden-reply");var f=d.slice(0,-this.options.maxRepliesVisible);if(f.addClass("hidden-reply"),e.find("span.text").text()==this.options.textFormatter(this.options.hideRepliesText)&&f.addClass("visible"),d.length>this.options.maxRepliesVisible){if(!e.length){e=a("<li/>",{class:"toggle-all highlight-font-bold"});var g=a("<span/>",{class:"text"}),h=a("<span/>",{class:"caret"});e.append(g).append(h),c.prepend(e)}this.setToggleAllButtonText(e,!1)}else e.remove()},sortComments:function(a,b){var c=this;"popularity"==b?a.sort(function(a,b){var d=a.childs.length,e=b.childs.length;if(c.options.enableUpvoting&&(d+=a.upvoteCount,e+=b.upvoteCount),e!=d)return e-d;var f=new Date(a.created).getTime(),g=new Date(b.created).getTime();return g-f}):a.sort(function(a,c){var d=new Date(a.created).getTime(),e=new Date(c.created).getTime();return"oldest"==b?d-e:e-d})},sortUsers:function(a){a.sort(function(a,b){var c=a.fullname.toLowerCase().trim(),d=b.fullname.toLowerCase().trim();return c<d?-1:c>d?1:0})},sortAndReArrangeComments:function(b){var c=this.$el.find("#comment-list"),d=this.getComments().filter(function(a){return!a.parent});this.sortComments(d,b),a(d).each(function(a,b){var d=c.find("> li.comment[data-id="+b.id+"]");c.append(d)})},showActiveSort:function(){var a=this.$el.find('.navigation li[data-sort-key="'+this.currentSortKey+'"]');this.$el.find(".navigation li").removeClass("active"),a.addClass("active");var b=this.$el.find(".navigation .title");if("attachments"!=this.currentSortKey)b.addClass("active"),b.find("header").html(a.first().html());else{var c=this.$el.find(".navigation ul.dropdown").children().first();b.find("header").html(c.html())}this.showActiveContainer()},forceResponsive:function(){this.$el.addClass("responsive")},closeDropdowns:function(){this.$el.find(".dropdown").hide()},saveOnKeydown:function(b){if(13==b.keyCode){var c=b.metaKey||b.ctrlKey;if(this.options.postCommentOnEnter||c){var d=a(b.currentTarget);d.siblings(".control-row").find(".save").trigger("click"),b.stopPropagation(),b.preventDefault()}}},saveEditableContent:function(b){var c=a(b.currentTarget);c.data("before",c.html())},checkEditableContentForChange:function(b){var c=a(b.currentTarget);c.data("before")!=c.html()&&(c.data("before",c.html()),c.trigger("change"))},navigationElementClicked:function(b){var c=a(b.currentTarget),d=c.data().sortKey;"attachments"!=d&&this.sortAndReArrangeComments(d),this.currentSortKey=d,this.showActiveSort()},toggleNavigationDropdown:function(b){b.stopPropagation();var c=a(b.currentTarget).find("~ .dropdown");c.toggle()},showMainCommentingField:function(b){var c=a(b.currentTarget);c.siblings(".control-row").show(),c.parent().find(".close").show(),c.focus()},hideMainCommentingField:function(b){var c=a(b.currentTarget),d=this.$el.find(".commenting-field.main .textarea"),e=this.$el.find(".commenting-field.main .control-row");this.clearTextarea(d),this.adjustTextareaHeight(d,!1),e.hide(),c.hide(),d.blur()},increaseTextareaHeight:function(b){var c=a(b.currentTarget);this.adjustTextareaHeight(c,!0)},textareaContentChanged:function(b){var c=a(b.currentTarget),d=c.siblings(".control-row").find(".save");if(!c.find(".reply-to.tag").length){var e=c.attr("data-comment");if(e){var f=c.parents("li.comment");if(f.length>1){var g=f.last().data("id");c.attr("data-parent",g)}}else{var g=c.parents("li.comment").last().data("id");c.attr("data-parent",g)}}var h=c.parents(".commenting-field").first();c[0].scrollHeight>c.outerHeight()?h.addClass("scrollable"):h.removeClass("scrollable");var i=!0,j=this.getTextareaContent(c,!0);if(e=c.attr("data-comment")){var l,k=j!=this.commentsById[e].content;this.commentsById[e].parent&&(l=this.commentsById[e].parent.toString());var m=c.attr("data-parent")!=l;i=k||m}j.length&&i?d.addClass("enabled"):d.removeClass("enabled")},removeCommentingField:function(b){var c=a(b.currentTarget),d=c.siblings(".textarea");d.attr("data-comment")&&c.parents("li.comment").first().removeClass("edit");var e=c.parents(".commenting-field").first();e.remove()},postComment:function(b){var c=this,d=a(b.currentTarget),e=d.parents(".commenting-field").first(),f=e.find(".textarea");d.removeClass("enabled");var g=this.createCommentJSON(f);g=this.applyExternalMappings(g);var h=function(a){c.createComment(a),e.find(".close").trigger("click")},i=function(){d.addClass("enabled")};this.options.postComment(g,h,i)},createComment:function(a){var b=this.createCommentModel(a);this.addCommentToDataModel(b),this.addComment(b)},putComment:function(b){var c=this,d=a(b.currentTarget),e=d.parents(".commenting-field").first(),f=e.find(".textarea");d.removeClass("enabled");var g=a.extend({},this.commentsById[f.attr("data-comment")]);a.extend(g,{parent:f.attr("data-parent")||null,content:this.getTextareaContent(f),pings:this.getPings(f),modified:(new Date).getTime()}),g=this.applyExternalMappings(g);var h=function(a){var b=c.createCommentModel(a);delete b.childs,c.updateCommentModel(b),e.find(".close").trigger("click"),c.reRenderComment(b.id)},i=function(){d.addClass("enabled")};this.options.putComment(g,h,i)},deleteComment:function(b){var c=this,d=a(b.currentTarget),e=d.parents(".comment").first(),f=a.extend({},this.commentsById[e.attr("data-id")]),g=f.id,h=f.parent;d.removeClass("enabled"),f=this.applyExternalMappings(f);var i=function(){c.removeComment(g),h&&c.reRenderCommentActionBar(h)},j=function(){d.addClass("enabled")};this.options.deleteComment(f,i,j)},hashtagClicked:function(b){var c=a(b.currentTarget),d=c.attr("data-value");this.options.hashtagClicked(d)},pingClicked:function(b){var c=a(b.currentTarget),d=c.attr("data-value");this.options.pingClicked(d)},fileInputChanged:function(b,c){var c=b.currentTarget.files,d=a(b.currentTarget).parents(".commenting-field").first();this.uploadAttachments(c,d)},upvoteComment:function(b){var g,c=this,d=a(b.currentTarget).parents("li.comment").first(),e=d.data().model,f=e.upvoteCount;g=e.userHasUpvoted?f-1:f+1,e.userHasUpvoted=!e.userHasUpvoted,e.upvoteCount=g,this.reRenderUpvotes(e.id);var h=a.extend({},e);h=this.applyExternalMappings(h);var i=function(a){var b=c.createCommentModel(a);c.updateCommentModel(b),c.reRenderUpvotes(b.id)},j=function(){e.userHasUpvoted=!e.userHasUpvoted,e.upvoteCount=f,c.reRenderUpvotes(e.id)};this.options.upvoteComment(h,i,j)},toggleReplies:function(b){var c=a(b.currentTarget);c.siblings(".hidden-reply").toggleClass("visible"),this.setToggleAllButtonText(c,!0)},replyButtonClicked:function(b){var c=a(b.currentTarget),d=c.parents("li.comment").last(),e=c.parents(".comment").first().data().id,f=d.find(".child-comments > .commenting-field");f.length&&f.remove();var g=f.find(".textarea").attr("data-parent");if(g!=e){f=this.createCommentingFieldElement(e),d.find(".child-comments").append(f);var h=f.find(".textarea");this.moveCursorToEnd(h)}},editButtonClicked:function(b){var c=a(b.currentTarget),d=c.parents("li.comment").first(),e=d.data().model;d.addClass("edit");var f=this.createCommentingFieldElement(e.parent,e.id);d.find(".comment-wrapper").first().append(f);var g=f.find(".textarea");g.attr("data-comment",e.id),g.append(this.getFormattedCommentContent(e,!0)),this.moveCursorToEnd(g)},showDroppableOverlay:function(a){this.options.enableAttachments&&(this.$el.find(".droppable-overlay").css("top",this.$el[0].scrollTop),this.$el.find(".droppable-overlay").show(),this.$el.addClass("drag-ongoing"))},handleDragEnter:function(b){var c=a(b.currentTarget).data("dnd-count")||0;c++,a(b.currentTarget).data("dnd-count",c),a(b.currentTarget).addClass("drag-over")},handleDragLeave:function(b,c){var d=a(b.currentTarget).data("dnd-count");d--,a(b.currentTarget).data("dnd-count",d),0==d&&(a(b.currentTarget).removeClass("drag-over"),c&&c())},handleDragLeaveForOverlay:function(a){var b=this;this.handleDragLeave(a,function(){b.hideDroppableOverlay()})},handleDragLeaveForDroppable:function(a){this.handleDragLeave(a)},handleDragOverForOverlay:function(a){a.stopPropagation(),a.preventDefault(),a.originalEvent.dataTransfer.dropEffect="copy"},hideDroppableOverlay:function(){this.$el.find(".droppable-overlay").hide(),this.$el.removeClass("drag-ongoing")},handleDrop:function(b){b.preventDefault(),a(b.target).trigger("dragleave"),this.hideDroppableOverlay(),this.uploadAttachments(b.originalEvent.dataTransfer.files)},stopPropagation:function(a){a.stopPropagation()},createHTML:function(){var c=this.createCommentingFieldElement();c.addClass("main"),this.$el.append(c);var d=c.find(".control-row");d.hide(),c.find(".close").hide(),this.options.enableNavigation&&(this.$el.append(this.createNavigationElement()),this.showActiveSort());var e=this.createSpinner();this.$el.append(e);var f=a("<div/>",{class:"data-container","data-container":"comments"});this.$el.append(f);var g=a("<div/>",{class:"no-comments no-data",text:this.options.textFormatter(this.options.noCommentsText)}),h=a("<i/>",{class:"fa fa-comments fa-2x"});if(this.options.noCommentsIconURL.length&&(h.css("background-image",'url("'+this.options.noCommentsIconURL+'")'),h.addClass("image")),g.prepend(a("<br/>")).prepend(h),f.append(g),this.options.enableAttachments){var i=a("<div/>",{class:"data-container","data-container":"attachments"});this.$el.append(i);var j=a("<div/>",{class:"no-attachments no-data",text:this.options.textFormatter(this.options.noAttachmentsText)}),k=a("<i/>",{class:"fa fa-paperclip fa-2x"});this.options.attachmentIconURL.length&&(k.css("background-image",'url("'+this.options.attachmentIconURL+'")'),k.addClass("image")),j.prepend(a("<br/>")).prepend(k),i.append(j);var l=a("<div/>",{class:"droppable-overlay"}),m=a("<div/>",{class:"droppable-container"}),n=a("<div/>",{class:"droppable"}),o=a("<i/>",{class:"fa fa-upload fa-4x"});this.options.uploadIconURL.length&&(o.css("background-image",'url("'+this.options.uploadIconURL+'")'),o.addClass("image"));var p=a("<div/>",{text:this.options.textFormatter(this.options.attachmentDropText)});n.append(o),n.append(p),l.html(m.html(n)).hide(),this.$el.append(l)}},createProfilePictureElement:function(b){if(b)var c=a("<img/>",{src:b});else var c=a("<i/>",{class:"fa fa-user"});return c.addClass("profile-picture"),this.options.roundProfilePictures&&c.addClass("round"),c},createCommentingFieldElement:function(b,c){var d=this,e=a("<div/>",{class:"commenting-field"});if(c)var f=this.commentsById[c].profilePictureURL;else var f=this.options.profilePictureURL;var g=this.createProfilePictureElement(f),h=a("<div/>",{class:"textarea-wrapper"}),i=a("<div/>",{class:"control-row"}),j=a("<div/>",{class:"textarea","data-placeholder":this.options.textFormatter(this.options.textareaPlaceholderText),contenteditable:!0});this.adjustTextareaHeight(j,!1);var k=a("<span/>",{class:"close"}).append(a('<span class="left"/>')).append(a('<span class="right"/>'));if(c){var l=this.options.textFormatter(this.options.saveText),m=a("<span/>",{class:"delete",text:this.options.textFormatter(this.options.deleteText)}).css("background-color",this.options.deleteButtonColor);i.append(m),this.isAllowedToDelete(c)&&m.addClass("enabled")}else{var l=this.options.textFormatter(this.options.sendText);if(this.options.enableAttachments){var n=a("<span/>",{class:"enabled upload"}),o=a("<i/>",{class:"fa fa-upload"}),p=a("<input/>",{type:"file","data-role":"none"});a.browser.mobile||p.attr("multiple","multiple"),this.options.uploadIconURL.length&&(o.css("background-image",'url("'+this.options.uploadIconURL+'")'),o.addClass("image")),n.append(o).append(p),i.append(n)}}var q=c?"update":"send",r=a("<span/>",{class:q+" save highlight-background",text:l});if(i.prepend(r),h.append(k).append(j).append(i),e.append(g).append(h),b){j.attr("data-parent",b);var s=this.commentsById[b];if(s.parent){j.html("&nbsp;");var t="@"+s.fullname,u=this.createTagElement(t,"reply-to",s.creator);j.prepend(u)}}return this.options.enablePinging&&(j.textcomplete([{match:/(^|\s)@(([a-zÃ¤Ã¶Ã¼Ã]|\s)*)$/im,search:function(b,c){b=d.normalizeSpaces(b);var e=d.getPings(j),f=d.getUsers().filter(function(a){var b=a.id==d.options.currentUserId,c=e.indexOf(a.id)!=-1;return!b&&!c});d.sortUsers(f),c(a.map(f,function(a){var c=b.toLowerCase(),d=a.fullname.toLowerCase().indexOf(c)!=-1;return d?a:null}))},template:function(b){var c=a("<div/>"),d=a("<img/>",{src:b.profile_picture_url,class:"profile-picture round"}),e=a("<div/>",{class:"details"}),f=a("<div/>",{class:"name"}).html(b.fullname),g=a("<div/>",{class:"email"}).html(b.email);return e.append(f).append(g),c.append(d).append(e),c.html()},replace:function(a){var b=d.createTagElement("@"+a.fullname,"ping",a.id);return" "+b[0].outerHTML+" "}}],{appendTo:".jquery-comments",dropdownClassName:"dropdown autocomplete",maxCount:5,rightEdgeOffset:0}),j.on({"textComplete:show":function(b){var c=a(this).data("textComplete").dropdown.$el;c.hide();var e=function(){return!c.is(":empty")},f=function(){var a=parseInt(c.css("left"));c.css("left",0);var b=d.$el.width()-c.width(),e=Math.min(b,a);c.css("left",e),c.show()};d.waitUntil(e,f)}})),e},createNavigationElement:function(){var b=a("<ul/>",{class:"navigation"}),c=a("<div/>",{class:"navigation-wrapper"});b.append(c);var d=a("<li/>",{text:this.options.textFormatter(this.options.newestText),"data-sort-key":"newest","data-container-name":"comments"}),e=a("<li/>",{text:this.options.textFormatter(this.options.oldestText),"data-sort-key":"oldest","data-container-name":"comments"}),f=a("<li/>",{text:this.options.textFormatter(this.options.popularText),"data-sort-key":"popularity","data-container-name":"comments"}),g=a("<li/>",{text:this.options.textFormatter(this.options.attachmentsText),"data-sort-key":"attachments","data-container-name":"attachments"}),h=a("<i/>",{class:"fa fa-paperclip"});this.options.attachmentIconURL.length&&(h.css("background-image",'url("'+this.options.attachmentIconURL+'")'),h.addClass("image")),g.prepend(h);var i=a("<div/>",{class:"navigation-wrapper responsive"}),j=a("<ul/>",{class:"dropdown"}),k=a("<li/>",{class:"title"}),l=a("<header/>");return k.append(l),i.append(k),i.append(j),b.append(i),c.append(d).append(e),j.append(d.clone()).append(e.clone()),(this.options.enableReplying||this.options.enableUpvoting)&&(c.append(f),j.append(f.clone())),this.options.enableAttachments&&(c.append(g),i.append(g.clone())),this.options.forceResponsive&&this.forceResponsive(),b},createSpinner:function(){var b=a("<div/>",{class:"spinner"}),c=a("<i/>",{class:"fa fa-spinner fa-spin"});return this.options.spinnerIconURL.length&&(c.css("background-image",'url("'+this.options.spinnerIconURL+'")'),c.addClass("image")),b.html(c),b},createCommentElement:function(b){var c=a("<li/>",{"data-id":b.id,class:"comment"}).data("model",b);b.createdByCurrentUser&&c.addClass("by-current-user"),b.createdByAdmin&&c.addClass("by-admin");var d=a("<ul/>",{class:"child-comments"}),e=this.createCommentWrapperElement(b);return c.append(e),null==b.parent&&c.append(d),c},createCommentWrapperElement:function(b){var c=a("<div/>",{class:"comment-wrapper"}),d=this.createProfilePictureElement(b.profilePictureURL),e=a("<time/>",{text:this.options.timeFormatter(b.created),"data-original":b.created}),f=b.createdByCurrentUser?this.options.textFormatter(this.options.youText):b.fullname,g=a("<div/>",{class:"name"});if(b.profileURL){var h=a("<a/>",{href:b.profileURL,text:f});g.html(h)}else g.text(f);if((b.createdByCurrentUser||b.createdByAdmin)&&g.addClass("highlight-font-bold"),b.parent){var i=this.commentsById[b.parent];if(i.parent){var j=a("<span/>",{class:"reply-to",text:i.fullname}),k=a("<i/>",{class:"fa fa-share"});this.options.replyIconURL.length&&(k.css("background-image",'url("'+this.options.replyIconURL+'")'),k.addClass("image")),j.prepend(k),g.append(j)}}var l=a("<div/>",{class:"wrapper"}),m=a("<div/>",{class:"content"}),n=void 0!=b.fileURL;if(n){var o=null,p=null;if(b.fileMimeType){var q=b.fileMimeType.split("/");2==q.length&&(o=q[1],p=q[0])}var h=a("<a/>",{class:"attachment",href:b.fileURL,target:"_blank"});if("image"==p){var r=a("<img/>",{src:b.fileURL});h.html(r)}else if("video"==p){var s=a("<video/>",{src:b.fileURL,type:b.fileMimeType,controls:"controls"});h.html(s)}else{var t=["archive","audio","code","excel","image","movie","pdf","photo","picture","powerpoint","sound","video","word","zip"],u="fa fa-file-o";t.indexOf(o)>0?u="fa fa-file-"+o+"-o":t.indexOf(p)>0&&(u="fa fa-file-"+p+"-o");var v=a("<i/>",{class:u});this.options.fileIconURL.length&&(v.css("background-image",'url("'+this.options.fileIconURL+'")'),v.addClass("image"));var w=b.fileURL.split("/"),x=w[w.length-1];x=x.split("?")[0],x=decodeURIComponent(x),h.text(x),h.prepend(v)}m.html(h)}else m.html(this.getFormattedCommentContent(b));if(b.modified&&b.modified!=b.created){var y=this.options.timeFormatter(b.modified),z=a("<time/>",{class:"edited",text:this.options.textFormatter(this.options.editedText)+" "+y,"data-original":b.modified});m.append(z)}var A=a("<span/>",{class:"actions"}),B=a("<span/>",{class:"separator",text:"Â·"}),C=a("<button/>",{class:"action reply",type:"button",text:this.options.textFormatter(this.options.replyText)}),D=a("<i/>",{class:"fa fa-thumbs-up"});this.options.upvoteIconURL.length&&(D.css("background-image",'url("'+this.options.upvoteIconURL+'")'),D.addClass("image"));var E=this.createUpvoteElement(b);if(this.options.enableReplying&&A.append(C),this.options.enableUpvoting&&A.append(E),b.createdByCurrentUser||this.options.currentUserIsAdmin)if(n&&this.isAllowedToDelete(b.id)){var F=a("<button/>",{class:"action delete enabled",text:this.options.textFormatter(this.options.deleteText)});A.append(F)}else if(!n&&this.options.enableEditing){var G=a("<button/>",{class:"action edit",text:this.options.textFormatter(this.options.editText)});A.append(G)}return A.children().each(function(b,c){a(c).is(":last-child")||a(c).after(B.clone())}),l.append(m),l.append(A),c.append(d).append(e).append(g).append(l),c},createUpvoteElement:function(b){var c=a("<i/>",{class:"fa fa-thumbs-up"});this.options.upvoteIconURL.length&&(c.css("background-image",'url("'+this.options.upvoteIconURL+'")'),c.addClass("image"));var d=a("<button/>",{class:"action upvote"+(b.userHasUpvoted?" highlight-font":"")}).append(a("<span/>",{text:b.upvoteCount,class:"upvote-count"})).append(c);return d},createTagElement:function(b,c,d){var e=a("<input/>",{class:"tag",type:"button","data-role":"none"});return c&&e.addClass(c),e.val(b),e.attr("data-value",d),e},reRenderComment:function(b){var c=this.commentsById[b],d=this.$el.find('li.comment[data-id="'+c.id+'"]'),e=this;d.each(function(b,d){var f=e.createCommentWrapperElement(c);a(d).find(".comment-wrapper").first().replaceWith(f)})},reRenderCommentActionBar:function(b){var c=this.commentsById[b],d=this.$el.find('li.comment[data-id="'+c.id+'"]'),e=this;d.each(function(b,d){var f=e.createCommentWrapperElement(c);a(d).find(".actions").first().replaceWith(f.find(".actions"))})},reRenderUpvotes:function(b){var c=this.commentsById[b],d=this.$el.find('li.comment[data-id="'+c.id+'"]'),e=this;d.each(function(b,d){var f=e.createUpvoteElement(c);a(d).find(".upvote").first().replaceWith(f)})},createCssDeclarations:function(){a("head style.jquery-comments-css").remove(),this.createCss(".jquery-comments ul.navigation li.active:after {background: "+this.options.highlightColor+" !important;",NaN),this.createCss(".jquery-comments ul.navigation ul.dropdown li.active {background: "+this.options.highlightColor+" !important;",NaN),this.createCss(".jquery-comments .highlight-background {background: "+this.options.highlightColor+" !important;",NaN),this.createCss(".jquery-comments .highlight-font {color: "+this.options.highlightColor+" !important;}"),this.createCss(".jquery-comments .highlight-font-bold {color: "+this.options.highlightColor+" !important;font-weight: bold;}")},createCss:function(b){var c=a("<style/>",{type:"text/css",class:"jquery-comments-css",text:b});a("head").append(c)},getComments:function(){var a=this;return Object.keys(this.commentsById).map(function(b){return a.commentsById[b]})},getUsers:function(){var a=this;return Object.keys(this.usersById).map(function(b){return a.usersById[b]})},getChildComments:function(a){return this.getComments().filter(function(b){return b.parent==a})},getAttachments:function(){return this.getComments().filter(function(a){return void 0!=a.fileURL})},getOutermostParent:function(a){var b=a;do{var c=this.commentsById[b];b=c.parent}while(null!=c.parent);return c},createCommentJSON:function(a){var b=(new Date).toISOString(),c={id:"c"+(this.getComments().length+1),parent:a.attr("data-parent")||null,created:b,modified:b,content:this.getTextareaContent(a),pings:this.getPings(a),fullname:this.options.textFormatter(this.options.youText),profilePictureURL:this.options.profilePictureURL,createdByCurrentUser:!0,upvoteCount:0,userHasUpvoted:!1};return c},isAllowedToDelete:function(b){
if(this.options.enableDeleting){var c=!0;return this.options.enableDeletingCommentWithReplies||a(this.getComments()).each(function(a,d){d.parent==b&&(c=!1)}),c}return!1},setToggleAllButtonText:function(a,b){var c=this,d=a.find("span.text"),e=a.find(".caret"),f=function(){var b=c.options.textFormatter(c.options.viewAllRepliesText),e=a.siblings(".comment").length;b=b.replace("__replyCount__",e),d.text(b)},g=this.options.textFormatter(this.options.hideRepliesText);b?(d.text()==g?f():d.text(g),e.toggleClass("up")):d.text()!=g&&f()},adjustTextareaHeight:function(b,c){var d=2.2,e=1.45,f=function(a){var c=d+(a-1)*e;b.css("height",c+"em")};b=a(b);var g=1==c?this.options.textareaRowsOnFocus:this.options.textareaRows;do{f(g),g++;var h=b[0].scrollHeight>b.outerHeight(),i=0!=this.options.textareaMaxRows&&g>this.options.textareaMaxRows}while(h&&!i)},clearTextarea:function(a){a.empty().trigger("input")},getTextareaContent:function(b,c){var d=b.clone();d.find(".reply-to.tag").remove(),d.find(".tag.hashtag").replaceWith(function(){return c?a(this).val():"#"+a(this).attr("data-value")}),d.find(".tag.ping").replaceWith(function(){return c?a(this).val():"@"+a(this).attr("data-value")});var e=a("<pre/>").html(d.html());e.find("div, p, br").replaceWith(function(){return"\n"+this.innerHTML});var f=e.text().replace(/^\s+/g,"");return f},getFormattedCommentContent:function(a,b){var c=this.escape(a.content);return c=this.linkify(c),c=this.highlightTags(a,c),b&&(c=c.replace(/(?:\n)/g,"<br>")),c},getPings:function(b){return a.map(b.find(".ping"),function(b){return parseInt(a(b).attr("data-value"))})},moveCursorToEnd:function(b){if(b=a(b)[0],a(b).trigger("input"),a(b).scrollTop(b.scrollHeight),"undefined"!=typeof window.getSelection&&"undefined"!=typeof document.createRange){var c=document.createRange();c.selectNodeContents(b),c.collapse(!1);var d=window.getSelection();d.removeAllRanges(),d.addRange(c)}else if("undefined"!=typeof document.body.createTextRange){var e=document.body.createTextRange();e.moveToElementText(b),e.collapse(!1),e.select()}b.focus()},escape:function(b){return a("<pre/>").text(this.normalizeSpaces(b)).html()},normalizeSpaces:function(a){return a.replace("Â "," ")},after:function(a,b){var c=this;return function(){if(a--,0==a)return b.apply(c,arguments)}},highlightTags:function(a,b){return this.options.enableHashtags&&(b=this.highlightHashtags(a,b)),this.options.enablePinging&&(b=this.highlightPings(a,b)),b},highlightHashtags:function(a,b){var c=this;if(b.indexOf("#")!=-1){var d=function(a){var a=c.createTagElement("#"+a,"hashtag",a);return a[0].outerHTML},e=/(^|\s)#([a-zÃ¤Ã¶Ã¼Ã\d-_]+)/gim;b=b.replace(e,function(a,b,c){return b+d(c)})}return b},highlightPings:function(b,c){var d=this;if(c.indexOf("@")!=-1){var e=function(a){var b=d.createTagElement("@"+a.fullname,"ping",a.id);return b[0].outerHTML};a(b.pings).each(function(a,b){if(b in d.usersById){var f=d.usersById[b],g="@"+f.fullname;c=c.replace(g,e(f))}})}return c},linkify:function(a){var b,c,d,e;c=/(^|\s)((https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gim,b=a.replace(c,'$1<a href="$2" target="_blank">$2</a>'),d=/(^|\s)(www\.[\S]+(\b|$))/gim,b=b.replace(d,'$1<a href="http://$2" target="_blank">$2</a>'),e=/(^|\s)(([a-zA-Z0-9\-\_\.]+)@[a-zA-Z\_]+?(\.[a-zA-Z]{2,6})+)/gim,b=b.replace(e,'$1<a href="mailto:$2">$2</a>');var f=a.match(/<a href/g)||[];if(f.length>0){for(var g=a.split(/(<\/a>)/g),h=0;h<g.length;h++)null==g[h].match(/<a href/g)&&(g[h]=g[h].replace(c,'<a href="$1" target="_blank">$1</a>').replace(d,'$1<a href="http://$2" target="_blank">$2</a>').replace(e,'<a href="mailto:$1">$1</a>'));var i=g.join("");return i}return b},waitUntil:function(a,b){var c=this;a()?b():setTimeout(function(){c.waitUntil(a,b)},100)},applyInternalMappings:function(a){var b={},c=this.options.fieldMappings;for(var d in c)c.hasOwnProperty(d)&&(b[c[d]]=d);return this.applyMappings(b,a)},applyExternalMappings:function(a){var b=this.options.fieldMappings;return this.applyMappings(b,a)},applyMappings:function(a,b){var c={};for(var d in b)if(d in a){var e=a[d];c[e]=b[d]}return c}};a.fn.comments=function(c){return this.each(function(){var d=Object.create(b);a.data(this,"comments",d),d.init(c||{},this)})}});